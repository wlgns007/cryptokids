<!doctype html>
<html>
<head>
  <link rel="icon" href="data:,">
  <link rel="manifest" href="/manifest.webmanifest">
  <meta name="theme-color" content="#ffffff">
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => navigator.serviceWorker.register('/sw.js'));
    }
  </script>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CryptoKids – Child</title>
  <style>
    body{font-family:system-ui,Arial;margin:16px}
    .row{display:flex;gap:8px;margin:8px 0;flex-wrap:wrap}
    input,button{padding:8px;font-size:16px}
    #historyBox{margin-top:12px;border:1px solid #ddd;padding:8px;border-radius:8px;max-width:640px}
    .tx{padding:6px 0;border-bottom:1px dashed #eee}
/* make first card sit flush at the top, and all H2s align left */
.card:first-of-type { margin-top: 0 !important; }
h2 { margin-left: 0 !important; }

  </style>
  <!-- ADD into <head> ... </head> in child.html -->
  <style>
    /* Shop thumbnails */
    #secShop .row {
      display: grid;
      grid-template-columns: 96px 1fr auto;
      gap: 12px;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid #eee;
    }
    #secShop .thumb {
      width: 96px;
      height: 96px;
      object-fit: cover;       /* center-crop big images */
      border-radius: 12px;
      display: block;
    }
    #secShop .title { font-weight: 600; }
    #secShop .desc  { font-size: 0.92rem; opacity: 0.8; }
    #secShop .url   { font-size: 0.8rem; word-break: break-all; opacity: 0.7; }
    #secShop .actions button { padding: 6px 10px; border-radius: 10px; }
  </style>

</head>
<body>
<section class="card">
  <h2 style="margin-left:0">Scan Earn QR</h2>
  <button id="btnScan" style="padding:8px 14px;border:1px solid #ddd;border-radius:8px;background:#fff">Start Camera</button>
  <video id="vid" playsinline style="width:100%;max-width:420px;border-radius:12px;margin-top:10px;display:none"></video>
  <canvas id="cv" style="display:none"></canvas>
  <div id="scanMsg" class="help" style="min-height:18px;margin-top:8px"></div>
</section>

<script src="https://unpkg.com/jsqr"></script>
<!-- add just below jsqr -->
<script src="/qrcode.min.js"></script>
<script>
  (function () {
    const btn = document.getElementById('btnScan');
    const vid = document.getElementById('vid');
    const cv  = document.getElementById('cv');
    const ctx = cv.getContext('2d');
    const msg = document.getElementById('scanMsg');
    let stream = null, raf = 0, busy = false;

    function say(s){ msg.textContent = s; }
    function secureOk(){
      if (location.protocol === 'https:' || location.hostname === 'localhost') return true;
      return false;
    }

    async function start() {
      if (!secureOk()) {
        say('Camera requires HTTPS. Open the ngrok https://… URL.');
        return;
      }
      if (!navigator.mediaDevices?.getUserMedia) {
        say('Camera API not available in this browser.');
        return;
      }
      try {
        // Try back camera; fall back to any camera
        const try1 = { video: { facingMode: { ideal: 'environment' } } };
        const try2 = { video: true };

        try { stream = await navigator.mediaDevices.getUserMedia(try1); }
        catch { stream = await navigator.mediaDevices.getUserMedia(try2); }

        vid.srcObject = stream;
        vid.style.display = 'block';
        await vid.play();
        say('Point the camera at the QR code.');
        tick();
      } catch (e) {
        const name = e && e.name || '';
        if (name === 'NotAllowedError') say('Camera permission denied. Check site permissions in your browser settings.');
        else if (name === 'NotFoundError') say('No camera found.');
        else if (name === 'NotReadableError') say('Camera in use by another app.');
        else say('Camera blocked or unavailable.');
      }
    }

    function stop() {
      cancelAnimationFrame(raf);
      if (stream) stream.getTracks().forEach(t => t.stop());
      stream = null;
      vid.style.display = 'none';
      say('Camera stopped.');
    }

    function tick() {
      if (vid.readyState === vid.HAVE_ENOUGH_DATA) {
        cv.width = vid.videoWidth; cv.height = vid.videoHeight;
        ctx.drawImage(vid, 0, 0, cv.width, cv.height);
        const img = ctx.getImageData(0, 0, cv.width, cv.height);
        const code = jsQR(img.data, img.width, img.height, { inversionAttempts: 'dontInvert' });
        if (code && code.data && !busy) {
          busy = true;
          say('QR detected. Opening…');
          stop();
          location.href = code.data; // your /earn already returns a full URL
          return;
        }
      }
      raf = requestAnimationFrame(tick);
    }

    btn.addEventListener('click', () => {
      if (stream) stop(); else start();
    });
  })();
</script>

  <h2>CryptoKids – Balance</h2>

  <div class="row">
    <input id="userId" placeholder="User ID (e.g., leo)" />
    <button id="btnBalance">Check Balance</button>
    <button id="btnHistory">View History</button>
    <button id="btnCsv">Download CSV</button>
    <button id="btnWatch">Start Live Watch</button>
  </div>

  <div id="resp"></div>
<!-- ADD: history controls + totals -->
<div id="histControls" style="margin-top:8px; display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
  <label><input id="fltEarn" type="checkbox" checked> Show Earn</label>
  <label><input id="fltSpend" type="checkbox" checked> Show Spend</label>
  <span id="totals" style="opacity:.8;"></span>
</div>

<!-- === Shop (merged from shop.html) === -->
<section id="secShop" class="card">
  <h2>Shop</h2>
  <div class="toolbar">
    <button id="btnLoadShop">Load items</button>
    <label style="margin-left:12px;">
      <input type="checkbox" id="toggleShowUrls"> show image URLs
    </label>
  </div>
  <div id="shopList" class="list"></div>
  <p id="shopEmpty" style="display:none;">No items yet.</p>
  <!-- add inside the Shop section, after #shopEmpty -->
  <div id="shopQrBox" class="qrbox" style="margin-top:10px;"></div>
</section>
<!-- === Earn Points === -->
<section id="secEarn" class="card">
  <h2>Earn Points</h2>
  <div class="row">
    <label>Choose task:</label>
    <select id="earnTemplate"></select>
  </div>
  <div class="row">
    <button id="btnEarnQr">Generate Earn QR</button>
  </div>
  <div id="earnQrBox" class="qrbox"></div>
</section>

<!-- Modal-ish confirm for buying -->
<div id="buyConfirm" class="modal" style="display:none;">
  <div class="modal-content">
    <h3 id="buyTitle">Confirm purchase</h3>
    <p id="buyDesc"></p>
    <button id="btnBuyNow">Buy</button>
    <button id="btnBuyCancel">Cancel</button>
  </div>
</div>

  <div id="historyBox"></div>

  <div id="emptyState" style="display:none; margin-top:12px; padding:12px; border:1px dashed #bbb; border-radius:10px;">
    <div style="font-weight:600; margin-bottom:6px;">No RT yet</div>
    <div style="font-size:14px; line-height:1.4;">
      Ask a parent to give you a task and scan the Earn QR to get started.
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);

    async function getJSON(url) {
      const r = await fetch(url);
      if (!r.ok) throw new Error(await r.text());
      return r.json();
    }
// ADD: format helpers
function fmtIso(ts){ return new Date(ts).toLocaleString(); }
function summarize(hist){
  let earned = 0, spent = 0;
  for (const tx of hist){
    if (tx.type === 'earn') earned += Number(tx.amount)||0;
    if (tx.type === 'spend') spent  += Number(tx.amount)||0;
  }
  return { earned, spent };
}

    async function checkBalance() {
      const userId = $('userId').value.trim();
      const respBox = $('resp');
      const emptyState = $('emptyState');
      const qrEl = $('qr'); // ok if not present

      if (!userId) { alert('Enter User ID'); return; }
      respBox.textContent = 'Checking...';

      try {
        const data = await getJSON(`/balance/${encodeURIComponent(userId)}`);
        respBox.textContent = `Balance: ${data.balance} RT`;

// ADD: show lifetime totals next to balance (best-effort)
try {
  const sum = await getJSON(`/summary/${encodeURIComponent(userId)}`);
  respBox.textContent += `  |  Earned: ${sum.earned} RT, Spent: ${sum.spent} RT`;
} catch(_) {}

        const isEmpty = !Number.isFinite(data.balance) || data.balance <= 0;
        emptyState.style.display = isEmpty ? 'block' : 'none';

        if (qrEl) {
          if (isEmpty) {
            if (qrEl.tagName === 'CANVAS') {
              const ctx = qrEl.getContext('2d');
              ctx && ctx.clearRect(0, 0, qrEl.width, qrEl.height);
            }
            qrEl.style.display = 'none';
          } else {
            qrEl.style.display = '';
          }
        }
      } catch (err) {
        respBox.textContent = `Error checking balance: ${err.message}`;
        emptyState.style.display = 'none';
      }
    }

    $('btnBalance').onclick = checkBalance;

    // REPLACE the whole btnHistory handler with this
$('btnHistory').onclick = async () => {
  const userId = $('userId').value.trim();
  if (!userId) return alert('Enter User ID');

  const hist = await getJSON(`/history/${encodeURIComponent(userId)}`);
  const totals = summarize(hist);
  const showEarn  = $('fltEarn')?.checked !== false;
  const showSpend = $('fltSpend')?.checked !== false;

  // update totals line
  const t = $('totals');
  if (t) t.textContent = `Totals — Earned: ${totals.earned} RT, Spent: ${totals.spent} RT`;

  // filter by checkboxes
  const filtered = hist.filter(tx =>
    (tx.type === 'earn'  && showEarn) ||
    (tx.type === 'spend' && showSpend)
  );

  $('historyBox').innerHTML = filtered.length
    ? filtered.map(tx => `<div class="tx"><b>${tx.type}</b> ${tx.amount} RT${tx.reason ? ` – ${tx.reason}` : ''}<br><small>${fmtIso(tx.date)}</small></div>`).join('')
    : '<i>No history matches the current filters.</i>';
};

// ALSO: re-render list live when toggles change (optional nicety)
['fltEarn','fltSpend'].forEach(id => {
  const el = document.getElementById(id);
  if (el) el.addEventListener('change', () => $('btnHistory').click());
});


    // CSV download (client-side)
    $('btnCsv').onclick = async () => {
      const userId = $('userId').value.trim();
      if (!userId) return alert('Enter User ID');

      const hist = await getJSON(`/history/${encodeURIComponent(userId)}`);
      if (!Array.isArray(hist) || !hist.length) {
        alert('No history yet to export.');
        return;
      }

      const header = ['type', 'amount', 'reason', 'date'];
      const rows = hist.map(tx => [
        tx.type ?? '',
        tx.amount ?? '',
        (tx.reason ?? '').toString().replace(/"/g, '""'),
        new Date(tx.date).toISOString()
      ]);
      const csv = [header.join(','), ...rows.map(r => r.map(x => `"${x}"`).join(','))].join('\r\n');

      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `history_${userId}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    };

    // Live watch: auto-refresh balance + empty-state
    let watchTimer = null;
    $('btnWatch').onclick = () => {
      const userId = $('userId').value.trim();
      if (!userId) return alert('Enter User ID');
      if (watchTimer) {
        clearInterval(watchTimer); watchTimer = null;
        $('btnWatch').textContent = 'Start Live Watch';
        return;
      }
      $('btnWatch').textContent = 'Stop Live Watch';
      watchTimer = setInterval(() => { checkBalance(); }, 3000);
      checkBalance(); // fire immediately
    };
  </script>

<script>

  // --- Shop state ---
let SHOP_ITEMS = [];
let PENDING_ITEM = null;

async function loadShop() {
  const res = await fetch('/api/rewards');          // expects [{id,title,price,imageUrl,desc}]
  const items = await res.json();
  SHOP_ITEMS = items || [];
  renderShop();
}

function renderShop() {
  const list = $('shopList');
  const empty = $('shopEmpty');
  list.innerHTML = '';
  if (!SHOP_ITEMS.length) { empty.style.display = ''; return; }
  empty.style.display = 'none';

  const showUrls = $('toggleShowUrls')?.checked;
  for (const it of SHOP_ITEMS) {
    const row = document.createElement('div');
    row.className = 'row';
    row.innerHTML = `
      <img src="${it.imageUrl || ''}" alt="" class="thumb" />
      <div class="col">
        <div class="title">${it.title} — <b>${it.price}</b> RT</div>
        <div class="desc">${it.desc || ''}</div>
        ${showUrls && it.imageUrl ? `<div class="url">${it.imageUrl}</div>` : ''}
      </div>
      <div class="col actions">
        <button data-id="${it.id}" class="btnBuy">Buy</button>
      </div>
    `;
    list.appendChild(row);
  }

  list.querySelectorAll('.btnBuy').forEach(btn => {
    btn.addEventListener('click', () => openBuyConfirm(btn.dataset.id));
  });
}

function openBuyConfirm(id) {
  PENDING_ITEM = SHOP_ITEMS.find(x => String(x.id) === String(id)) || null;
  if (!PENDING_ITEM) return;
  $('buyTitle').textContent = 'Confirm purchase';
  $('buyDesc').textContent  = `${PENDING_ITEM.title} — ${PENDING_ITEM.price} RT`;
  $('buyConfirm').style.display = 'block';
}
function closeBuyConfirm() {
  $('buyConfirm').style.display = 'none';
  PENDING_ITEM = null;
}

// BUY = generate a QR that admin will scan to redeem (will change to “pending” flow in Step 3)

async function buyNowGenerateQr() {
  if (!PENDING_ITEM) return;
  const userId = $('userId').value.trim();     // ← use #userId (exists)
  if (!userId) { alert('Missing user id'); return; }

  const res = await fetch('/shop/mintSpend', { // ← new route (matches index.js)
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({ userId, rewardId: PENDING_ITEM.id }) // ← rewardId, not itemId
  });
  const j = await res.json();
  if (!res.ok) { alert(j.error || 'Failed to mint'); return; }

  closeBuyConfirm();
  // show the QR for parent/admin to scan
  renderQrInto('shopQrBox', j.url);            // ← use existing QR helper/box
}

$('btnLoadShop')?.addEventListener('click', loadShop);
$('toggleShowUrls')?.addEventListener('change', renderShop);
$('btnBuyNow')?.addEventListener('click', buyNowGenerateQr);
$('btnBuyCancel')?.addEventListener('click', closeBuyConfirm);

</script>
<!-- load child behavior (shop + earn). bump v when you change the file -->
<script src="/child.js?v=ck8"></script>
<script>
  // Remove any section that renders a "My Balance" heading (in case a legacy script injects it)
  window.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('h2').forEach(h => {
      if (h.textContent.trim() === 'My Balance') {
        const sec = h.closest('section') || h.parentElement;
        if (sec) sec.remove();
      }
    });
  });
</script>
</body>
</html>
